<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Rocket ‚Üí Moon Landing</title>
  <style>
    :root { --ui: rgba(0,0,0,.35); --ui2: rgba(255,255,255,.12); }
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    canvas { display:block; width:100vw; height:100vh; touch-action:none; }

    .hud {
      position: fixed; left: 12px; top: 12px;
      padding: 10px 12px; border-radius: 14px;
      background: var(--ui); color: #fff; backdrop-filter: blur(8px);
      font-size: 13px; line-height: 1.35;
      border: 1px solid rgba(255,255,255,.14);
      user-select: none;
      min-width: 230px;
    }
    .hud b { font-weight: 800; }
    .row { display:flex; align-items:center; gap:10px; margin-top: 8px; }
    .row label { flex: 0 0 auto; opacity:.9; }
    .row input[type="range"]{ flex:1 1 auto; width: 190px; }
    .btns {
      position: fixed; right: 12px; bottom: 12px;
      display:grid; grid-template-columns: repeat(3, 64px);
      grid-template-rows: repeat(2, 64px);
      gap: 10px;
      user-select:none;
    }
    .btn {
      display:flex; align-items:center; justify-content:center;
      background: var(--ui);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff; border-radius: 18px;
      font-size: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      text-align:center;
      line-height:1.05;
    }
    .btn:active { transform: translateY(1px); }
    .btn.small { font-size: 12px; opacity:.95; }

    .hint { margin-top: 8px; opacity: .85; font-size: 12px; }
    .pill {
      display:inline-block; padding: 2px 8px; border-radius: 999px;
      background: var(--ui2); border: 1px solid rgba(255,255,255,.14);
      margin-right: 6px;
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 92px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,0.45);
      color: #fff;
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      font-size: 13px;
      opacity: 0;
      transition: opacity .2s ease;
      pointer-events:none;
      white-space: nowrap;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div class="hud" id="hud">
    <div><b>üöÄ Rocket ‚Üí üåï Moon Landing</b></div>
    <div class="hint">
      <span class="pill">‚Üê/‚Üí</span>Í∞ÅÎèÑ
      <span class="pill">‚Üë</span>Ï∂îÎ†•
      <span class="pill">R</span>Î¶¨ÏÖã
      <span class="pill">Space</span>Ï∂îÎ†• 0
    </div>

    <div class="row">
      <label>Í∞ÅÎèÑ</label>
      <input id="angle" type="range" min="-90" max="90" value="0" />
      <div id="angleVal" style="width:46px;text-align:right;opacity:.95">0¬∞</div>
    </div>

    <div class="row">
      <label>Ï∂îÎ†•</label>
      <input id="throttle" type="range" min="0" max="100" value="0" />
      <div id="thrVal" style="width:46px;text-align:right;opacity:.95">0%</div>
    </div>

    <div style="margin-top:10px; opacity:.95">
      Î™®Îìú: <b id="mode">ÏßÄÍµ¨</b><br/>
      Í≥†ÎèÑ: <b id="alt">0</b> m<br/>
      ÏÜçÎèÑ: <b id="spd">0</b> m/s<br/>
      Ïó∞Î£å: <b id="fuel">100</b> %
    </div>

    <div style="margin-top:10px; opacity:.9; font-size:12px">
      Îã¨ Ï∞©Î•ô Ï°∞Í±¥(Ìå®Îìú ÏúÑ):<br/>
      - ÏàòÏßÅÏÜçÎèÑ <b>6</b> m/s Ïù¥Ìïò<br/>
      - ÏàòÌèâÏÜçÎèÑ <b>3</b> m/s Ïù¥Ìïò<br/>
      - Í∞ÅÎèÑ <b>¬±10¬∞</b> Ïù¥ÎÇ¥
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Mobile controls -->
  <div class="btns" aria-hidden="true">
    <div class="btn small" id="reset">R<br/>Reset</div>
    <div class="btn" id="up">‚ñ≤<br/>Thrust</div>
    <div class="btn small" id="cut">0<br/>Cut</div>

    <div class="btn" id="left">‚óÄ<br/>Left</div>
    <div class="btn small" id="center">‚óé<br/>0¬∞</div>
    <div class="btn" id="right">‚ñ∂<br/>Right</div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const angleSlider = document.getElementById('angle');
  const throttleSlider = document.getElementById('throttle');
  const angleVal = document.getElementById('angleVal');
  const thrVal = document.getElementById('thrVal');

  const modeEl = document.getElementById('mode');
  const altEl = document.getElementById('alt');
  const spdEl = document.getElementById('spd');
  const fuelEl = document.getElementById('fuel');

  const toastEl = document.getElementById('toast');
  const btn = (id) => document.getElementById(id);

  let W=0,H=0, DPR=1;

  function resize(){
    DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    W = Math.floor(innerWidth * DPR);
    H = Math.floor(innerHeight * DPR);
    canvas.width = W;
    canvas.height = H;
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function smoothstep(t){ return t*t*(3-2*t); }

  function rgb(r,g,b){ return `rgb(${r|0},${g|0},${b|0})`; }
  function mixColor(c1,c2,t){
    return { r: lerp(c1.r,c2.r,t), g: lerp(c1.g,c2.g,t), b: lerp(c1.b,c2.b,t) };
  }

  // --- World / game params ---
  const world = {
    // Earth segment
    earthAirTop: 50000,
    earthMaxAltForBg: 120000,
    earthG: 9.81,
    earthDrag0: 0.0009,
    earthDragPower: 1.35,

    // Moon segment
    moonG: 1.62,
    moonDrag0: 0.00002,
    moonDragPower: 1.2,

    // Rocket controls
    turnRate: 80,      // deg/sec for keys/buttons
    throttleRate: 95,  // %/sec
    thrustMax: 28,     // m/s^2 at 100%
    fuelBurn: 0.22,    // %/sec at 100%

    // Visual
    launchPadWidthPx: 220,
    moonPadWidthMeters: 26,   // landing pad width in meters (world units)
    moonApproachAlt: 120000,  // when reached, start showing moon and switch mission
    moonSurfaceY: 0,          // moon ground altitude in moon-world (we reset y)
  };

  // Mission state
  const mission = {
    phase: "earth",  // "earth" | "transfer" | "moon" | "landed" | "crashed"
    // During moon phase:
    padX: 0,         // meters in moon world
    padY: 0
  };

  // Rocket state
  const rocket = {
    x: 0, y: 0,   // meters
    vx: 0, vy: 0, // m/s
    angleDeg: 0,
    throttle: 0,
    fuel: 100,
    alive: true,
    exploded: false,
    landed: false,
    t: 0
  };

  // Camera
  const cam = { x:0, y:0 };

  // Stars
  const stars = Array.from({length: 170}, () => ({
    x: Math.random(), y: Math.random(),
    s: Math.random()*1.8 + 0.2,
    tw: Math.random()*0.6 + 0.2
  }));

  // Background colors
  const sky = { r: 88, g: 180, b: 255 };
  const dusk = { r: 30, g: 60, b: 120 };
  const space = { r: 3, g: 5, b: 14 };
  const space2 = { r: 9, g: 10, b: 25 };

  function showToast(text, ms=1400){
    toastEl.textContent = text;
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
  }

  function reset(){
    rocket.x = 0; rocket.y = 0;
    rocket.vx = 0; rocket.vy = 0;
    rocket.angleDeg = 0;
    rocket.throttle = 0;
    rocket.fuel = 100;
    rocket.alive = true;
    rocket.exploded = false;
    rocket.landed = false;
    rocket.t = 0;

    mission.phase = "earth";
    mission.padX = 0;
    mission.padY = 0;

    angleSlider.value = "0";
    throttleSlider.value = "0";
    showToast("ÏßÄÍµ¨ÏóêÏÑú Î∞úÏÇ¨! Í≥†ÎèÑ 120km ÎÑòÏúºÎ©¥ Îã¨ Ï†ëÍ∑º!");
  }

  // UI sync
  function syncUI(){
    angleVal.textContent = `${rocket.angleDeg.toFixed(0)}¬∞`;
    thrVal.textContent = `${rocket.throttle.toFixed(0)}%`;
    altEl.textContent = `${Math.max(0, rocket.y).toFixed(0)}`;

    const spd = Math.hypot(rocket.vx, rocket.vy);
    spdEl.textContent = `${spd.toFixed(1)}`;
    fuelEl.textContent = `${rocket.fuel.toFixed(0)}`;

    const label = mission.phase === "earth" ? "ÏßÄÍµ¨"
                : mission.phase === "transfer" ? "Ï†ÑÏù¥(Îã¨ Ï†ëÍ∑º)"
                : mission.phase === "moon" ? "Îã¨"
                : mission.phase === "landed" ? "Ï∞©Î•ô ÏÑ±Í≥µ"
                : "Ï∂îÎùΩ";
    modeEl.textContent = label;
  }

  angleSlider.addEventListener('input', () => {
    rocket.angleDeg = parseFloat(angleSlider.value);
    syncUI();
  }, {passive:true});

  throttleSlider.addEventListener('input', () => {
    rocket.throttle = parseFloat(throttleSlider.value);
    syncUI();
  }, {passive:true});

  // Controls
  const keys = { left:false, right:false, up:false };
  addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if (k === 'arrowleft' || k === 'a') keys.left = true;
    if (k === 'arrowright' || k === 'd') keys.right = true;
    if (k === 'arrowup' || k === 'w') keys.up = true;
    if (k === 'r') reset();
    if (k === ' ') { rocket.throttle = 0; throttleSlider.value = "0"; }
  });
  addEventListener('keyup', (e) => {
    const k = e.key.toLowerCase();
    if (k === 'arrowleft' || k === 'a') keys.left = false;
    if (k === 'arrowright' || k === 'd') keys.right = false;
    if (k === 'arrowup' || k === 'w') keys.up = false;
  });

  function holdButton(el, onDown, onUp){
    const down = (e) => { e.preventDefault(); onDown(); };
    const up = (e) => { e.preventDefault(); onUp && onUp(); };
    el.addEventListener('pointerdown', down);
    el.addEventListener('pointerup', up);
    el.addEventListener('pointercancel', up);
    el.addEventListener('pointerleave', up);
  }
  holdButton(btn('left'), () => keys.left = true, () => keys.left = false);
  holdButton(btn('right'), () => keys.right = true, () => keys.right = false);
  holdButton(btn('up'), () => keys.up = true, () => keys.up = false);

  btn('reset').addEventListener('click', reset);
  btn('cut').addEventListener('click', () => { rocket.throttle = 0; throttleSlider.value="0"; syncUI(); });
  btn('center').addEventListener('click', () => { rocket.angleDeg = 0; angleSlider.value="0"; syncUI(); });

  // Scale (meters -> pixels)
  function metersToPixels(m){
    // zoom out gradually with altitude
    const z = 1 / (1 + Math.max(0, rocket.y)/70000);
    const base = 2.2 * DPR;
    return m * base * (0.7 + 0.6*z);
  }

  function worldToScreenX(mx){
    const px = metersToPixels(mx - cam.x);
    return W/2 + px;
  }
  function worldToScreenY(my){
    const py = metersToPixels(my - cam.y);
    return H*0.78 - py;
  }

  // Air density factor
  function airDensityFactorEarth(alt){
    const t = clamp(alt / world.earthAirTop, 0, 1);
    return Math.pow(1 - t, 2.2);
  }

  // Mission transition to moon
  function enterMoon(){
    mission.phase = "moon";
    // Place landing pad somewhere near x=0 (random but fair)
    mission.padX = (Math.random()*2 - 1) * 220; // -220..220 meters
    mission.padY = 0;

    // Reset "altitude reference": bring rocket to some altitude above moon surface
    // Keep sideways velocity feel, but clamp it.
    rocket.x = (Math.random()*2 - 1) * 180; // start offset
    rocket.y = 900; // 900m above surface
    rocket.vx = clamp(rocket.vx, -20, 20) * 0.35;
    rocket.vy = -6; // descending a bit
    rocket.angleDeg = 0;
    angleSlider.value = "0";
    showToast("üåï Îã¨ ÎèÑÏ∞©! Ìå®Îìú ÏúÑÏóê Î∂ÄÎìúÎüΩÍ≤å Ï∞©Î•ôÌï¥!");
  }

  // Landing check
  function checkLanding(){
    const withinPad = Math.abs(rocket.x - mission.padX) <= (world.moonPadWidthMeters/2);
    const angOk = Math.abs(rocket.angleDeg) <= 10;
    const vxOk = Math.abs(rocket.vx) <= 3;
    const vyOk = Math.abs(rocket.vy) <= 6; // downward speed
    return withinPad && angOk && vxOk && vyOk;
  }

  function update(dt){
    rocket.t += dt;

    // If end state: still allow tiny UI control but no physics
    if (!rocket.alive) { syncUI(); return; }

    // Key/button adjustments (sliders still override via input)
    if (keys.left)  rocket.angleDeg -= world.turnRate * dt;
    if (keys.right) rocket.angleDeg += world.turnRate * dt;
    rocket.angleDeg = clamp(rocket.angleDeg, -90, 90);
    angleSlider.value = String(rocket.angleDeg);

    if (keys.up && rocket.fuel > 0) {
      rocket.throttle += world.throttleRate * dt;
    } else {
      rocket.throttle -= world.throttleRate * 0.75 * dt;
    }
    rocket.throttle = clamp(rocket.throttle, 0, 100);
    throttleSlider.value = String(rocket.throttle);

    // Determine physics params by phase
    const isMoon = (mission.phase === "moon");
    const g = isMoon ? world.moonG : world.earthG;
    const drag0 = isMoon ? world.moonDrag0 : world.earthDrag0;
    const dragPow = isMoon ? world.moonDragPower : world.earthDragPower;

    // Thrust direction: 0¬∞ up
    const aRad = rocket.angleDeg * Math.PI / 180;
    const thrustDirX = Math.sin(aRad);
    const thrustDirY = Math.cos(aRad);

    let thrustAcc = 0;
    if (rocket.fuel > 0 && rocket.throttle > 0){
      thrustAcc = world.thrustMax * (rocket.throttle/100);
      rocket.fuel -= world.fuelBurn * (rocket.throttle/100) * dt;
      rocket.fuel = clamp(rocket.fuel, 0, 100);
      if (rocket.fuel <= 0){
        rocket.throttle = 0;
        throttleSlider.value = "0";
      }
    }

    // Drag
    const alt = Math.max(0, rocket.y);
    const dens = isMoon ? 0.02 : airDensityFactorEarth(alt);
    const speed = Math.hypot(rocket.vx, rocket.vy);
    const dragMag = drag0 * dens * Math.pow(speed, dragPow);
    const dragX = (speed > 1e-6) ? (-rocket.vx / speed) * dragMag : 0;
    const dragY = (speed > 1e-6) ? (-rocket.vy / speed) * dragMag : 0;

    // Acceleration
    const ax = thrustAcc * thrustDirX + dragX;
    const ay = thrustAcc * thrustDirY + dragY - g;

    rocket.vx += ax * dt;
    rocket.vy += ay * dt;

    rocket.x += rocket.vx * dt;
    rocket.y += rocket.vy * dt;

    // Transition to moon approach
    if (mission.phase === "earth" && rocket.y >= world.moonApproachAlt){
      mission.phase = "transfer";
      showToast("Ïö∞Ï£º ÎèÑÎã¨! Îã¨ Ï†ëÍ∑º Ï§ë‚Ä¶");
    }
    if (mission.phase === "transfer" && rocket.y >= world.moonApproachAlt + 12000){
      // once a bit higher, "arrive"
      enterMoon();
    }

    // Ground collision on moon
    if (mission.phase === "moon" && rocket.y <= 0){
      rocket.y = 0;
      if (checkLanding()){
        rocket.vx = 0; rocket.vy = 0;
        rocket.throttle = 0;
        rocket.alive = false;
        rocket.landed = true;
        mission.phase = "landed";
        showToast("‚úÖ Ï∞©Î•ô ÏÑ±Í≥µ! (RÎ°ú Îã§Ïãú)");
      } else {
        const impact = Math.hypot(rocket.vx, rocket.vy);
        rocket.vx = 0; rocket.vy = 0;
        rocket.alive = false;
        rocket.exploded = true;
        mission.phase = "crashed";
        showToast(`üí• Ï∂îÎùΩ! Ï°∞Í±¥ Î™ª ÎßûÏ∂§ (RÎ°ú Îã§Ïãú)`);
      }
    }

    // Ground collision on earth (below 0)
    if (mission.phase !== "moon" && rocket.y < 0){
      const impact = Math.hypot(rocket.vx, rocket.vy);
      rocket.y = 0;
      if (impact > 18){
        rocket.vx = 0; rocket.vy = 0;
        rocket.alive = false;
        rocket.exploded = true;
        mission.phase = "crashed";
        showToast("üí• ÏßÄÏÉÅ Ï∂îÎùΩ! RÎ°ú Î¶¨ÏÖã");
      } else {
        rocket.vy = 0;
        rocket.vx *= 0.35;
      }
    }

    syncUI();
  }

  // Drawing
  function drawBackground(){
    // If moon phase: darker and more space-y
    const isMoon = (mission.phase === "moon" || mission.phase === "landed" || mission.phase === "crashed");
    const alt = Math.max(0, rocket.y);

    if (!isMoon){
      // Earth sky->space based on altitude
      const t = clamp(alt / world.earthMaxAltForBg, 0, 1);
      const t1 = smoothstep(clamp(t*1.25, 0, 1));
      const t2 = smoothstep(clamp((t-0.35)/0.65, 0, 1));

      const cA = mixColor(sky, dusk, t1);
      const cB = mixColor(dusk, space, t2);
      const top = mixColor(cA, cB, t2);

      const bottom = mixColor(
        mixColor({r:120,g:210,b:255}, dusk, t1),
        mixColor(dusk, space2, t2),
        t2
      );

      const grad = ctx.createLinearGradient(0, 0, 0, H);
      grad.addColorStop(0, rgb(top.r, top.g, top.b));
      grad.addColorStop(1, rgb(bottom.r, bottom.g, bottom.b));
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,W,H);

      // Stars appear as you go up
      const starAlpha = smoothstep(clamp((alt-8000)/25000, 0, 1));
      drawStars(starAlpha);
    } else {
      // Moon: mostly space, subtle vignette
      const top = {r: 5, g: 6, b: 18};
      const bottom = {r: 2, g: 2, b: 8};
      const grad = ctx.createLinearGradient(0, 0, 0, H);
      grad.addColorStop(0, rgb(top.r, top.g, top.b));
      grad.addColorStop(1, rgb(bottom.r, bottom.g, bottom.b));
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,W,H);
      drawStars(1.0);
    }
  }

  function drawStars(alpha){
    if (alpha <= 0.01) return;
    ctx.save();
    ctx.globalAlpha = 0.85 * alpha;
    ctx.fillStyle = "white";
    for (const s of stars){
      const x = s.x * W;
      const y = s.y * H;
      const tw = 0.75 + 0.25*Math.sin((rocket.t*1.2 + s.x*10 + s.y*7) * s.tw);
      const r = (s.s * DPR) * tw;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawEarthGround(){
    const baseY = worldToScreenY(0);
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0, baseY, W, H - baseY);

    // launch pad
    const padW = world.launchPadWidthPx * DPR;
    const padH = 18 * DPR;
    const cx = W/2;
    ctx.fillStyle = "rgba(255,255,255,0.22)";
    ctx.fillRect(cx - padW/2, baseY - padH, padW, padH);
    ctx.restore();
  }

  function drawMoonSurface(){
    // Moon ground at y=0 in moon world
    const gy = worldToScreenY(0);

    // Surface band
    ctx.save();
    const grad = ctx.createLinearGradient(0, gy-120*DPR, 0, H);
    grad.addColorStop(0, "rgba(210,210,210,0.05)");
    grad.addColorStop(1, "rgba(200,200,200,0.20)");
    ctx.fillStyle = grad;
    ctx.fillRect(0, gy, W, H-gy);

    // Craters (simple circles) in screen space
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "white";
    for (let i=0;i<10;i++){
      const x = (i/9) * W + (Math.sin(i*9.1)*22*DPR);
      const r = (18 + (i%4)*10) * DPR;
      const y = gy + (25 + (i%3)*30) * DPR;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // Landing pad
    const padHalf = world.moonPadWidthMeters/2;
    const x1 = worldToScreenX(mission.padX - padHalf);
    const x2 = worldToScreenX(mission.padX + padHalf);
    const padH = 10*DPR;

    ctx.fillStyle = "rgba(255,255,255,0.28)";
    ctx.fillRect(Math.min(x1,x2), gy - padH, Math.abs(x2-x1), padH);

    // Flag at center
    const cx = worldToScreenX(mission.padX);
    ctx.strokeStyle = "rgba(255,255,255,0.55)";
    ctx.lineWidth = 2*DPR;
    ctx.beginPath();
    ctx.moveTo(cx, gy - padH);
    ctx.lineTo(cx, gy - padH - 32*DPR);
    ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,0.55)";
    ctx.beginPath();
    ctx.moveTo(cx, gy - padH - 32*DPR);
    ctx.lineTo(cx + 22*DPR, gy - padH - 26*DPR);
    ctx.lineTo(cx, gy - padH - 20*DPR);
    ctx.closePath();
    ctx.fill();

    ctx.restore();
  }

  function drawRocket(){
    const sx = worldToScreenX(rocket.x);
    const sy = worldToScreenY(rocket.y);

    const scale = clamp(1.15 - rocket.y/140000, 0.55, 1.15) * DPR;
    const bodyH = 54 * scale;
    const bodyW = 18 * scale;

    const aRad = rocket.angleDeg * Math.PI/180;

    ctx.save();
    ctx.translate(sx, sy);
    ctx.rotate(aRad);

    // flame
    const thrusting = rocket.alive && rocket.fuel > 0 && rocket.throttle > 0.5;
    if (thrusting){
      const p = rocket.throttle/100;
      const flameL = (18 + 40*p) * scale;
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "rgba(255,200,120,0.9)";
      ctx.beginPath();
      ctx.moveTo(0, bodyH/2 + 6*scale);
      ctx.quadraticCurveTo(-10*scale, bodyH/2 + flameL*0.55, 0, bodyH/2 + flameL);
      ctx.quadraticCurveTo( 10*scale, bodyH/2 + flameL*0.55, 0, bodyH/2 + 6*scale);
      ctx.closePath();
      ctx.fill();

      ctx.globalAlpha = 0.75;
      ctx.fillStyle = "rgba(255,120,80,0.9)";
      ctx.beginPath();
      ctx.moveTo(0, bodyH/2 + 6*scale);
      ctx.quadraticCurveTo(-6*scale, bodyH/2 + flameL*0.45, 0, bodyH/2 + flameL*0.78);
      ctx.quadraticCurveTo( 6*scale, bodyH/2 + flameL*0.45, 0, bodyH/2 + 6*scale);
      ctx.closePath();
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // body
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    roundRect(-bodyW/2, -bodyH/2, bodyW, bodyH, 10*scale);
    ctx.fill();

    // nose
    ctx.fillStyle = "rgba(230,230,240,0.95)";
    ctx.beginPath();
    ctx.moveTo(-bodyW/2, -bodyH/2 + 6*scale);
    ctx.lineTo(0, -bodyH/2 - 16*scale);
    ctx.lineTo(bodyW/2, -bodyH/2 + 6*scale);
    ctx.closePath();
    ctx.fill();

    // window
    ctx.fillStyle = "rgba(90,150,255,0.85)";
    ctx.beginPath();
    ctx.arc(0, -8*scale, 5.2*scale, 0, Math.PI*2);
    ctx.fill();

    // fins
    ctx.fillStyle = "rgba(220,220,230,0.95)";
    ctx.beginPath();
    ctx.moveTo(-bodyW/2, bodyH/2 - 6*scale);
    ctx.lineTo(-bodyW/2 - 12*scale, bodyH/2 + 8*scale);
    ctx.lineTo(-bodyW/2, bodyH/2 + 8*scale);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(bodyW/2, bodyH/2 - 6*scale);
    ctx.lineTo(bodyW/2 + 12*scale, bodyH/2 + 8*scale);
    ctx.lineTo(bodyW/2, bodyH/2 + 8*scale);
    ctx.closePath();
    ctx.fill();

    ctx.restore();

    // status text
    if (rocket.exploded){
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = `${Math.floor(22*DPR)}px system-ui`;
      ctx.fillText("üí• Ìè≠Î∞ú! RÎ°ú Î¶¨ÏÖã", 18*DPR, 44*DPR);
      ctx.restore();
    }
    if (rocket.landed){
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = `${Math.floor(22*DPR)}px system-ui`;
      ctx.fillText("‚úÖ Ï∞©Î•ô ÏÑ±Í≥µ! RÎ°ú Îã§Ïãú", 18*DPR, 44*DPR);
      ctx.restore();
    }
  }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawAltitudeMarkers(){
    // Only in earth phase (altitude scale)
    if (mission.phase === "moon" || mission.phase === "landed" || mission.phase === "crashed") return;

    const alt = Math.max(0, rocket.y);
    const base = Math.floor(alt/1000)*1000;
    ctx.save();
    ctx.globalAlpha = 0.7;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = `${Math.floor(12*DPR)}px system-ui`;

    for (let i=-2;i<=6;i++){
      const a = base + i*1000;
      if (a < 0) continue;
      const y = worldToScreenY(a);
      if (y < 0 || y > H) continue;
      ctx.fillRect(12*DPR, y, 22*DPR, 1*DPR);
      ctx.fillText(`${a/1000} km`, 40*DPR, y - 4*DPR);
    }
    ctx.restore();
  }

  function render(){
    // camera follows rocket
    cam.y = lerp(cam.y, rocket.y, 0.08);
    cam.x = lerp(cam.x, rocket.x, 0.05);

    drawBackground();

    if (mission.phase === "moon" || mission.phase === "landed" || mission.phase === "crashed") {
      drawMoonSurface();
    } else {
      drawEarthGround();
    }

    drawAltitudeMarkers();
    drawRocket();

    // helper crosshair
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.strokeStyle = "white";
    ctx.beginPath();
    ctx.moveTo(W/2, H*0.78);
    ctx.lineTo(W/2, H*0.78 - 30*DPR);
    ctx.stroke();
    ctx.restore();
  }

  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now - last) / 1000);
    last = now;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  reset();
  syncUI();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
